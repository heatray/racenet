'use strict';var UVDataLoadable=function(a){var b=this;var c=document.createElement("script");c.type="text/javascript";b.src=c.src=a;b.data=[];c.onload=function(){b.data=uvArray;if(typeof b.onload==='function'){b.onload()}};c.onerror=function(){if(typeof b.onerror==='function'){b.onerror()}};document.body.appendChild(c);document.getElementsByTagName('head')[0].appendChild(c)};var TiledImage=function(b,c,d){var e=this,internalImage=new Image();e.internalCanvas=document.createElement('canvas');internalImage.src=b;e.src=b;e.cols=c;e.rows=d;internalImage.onload=function(){e.internalCanvas.width=internalImage.width;e.internalCanvas.height=internalImage.height;e.width=internalImage.width/c;e.height=internalImage.height/d;var a=e.internalCanvas.getContext('2d');a.clearRect(0,0,internalImage.width,internalImage.height);a.drawImage(internalImage,0,0);if(typeof e.onload==='function'){e.onload()}};internalImage.onerror=function(){if(typeof e.onerror==='function'){e.onerror()}}};TiledImage.prototype.getTileData=function(x,y){var a=this.internalCanvas.getContext('2d');return a.getImageData(x*this.width,y*this.height,this.width,this.height)};TiledImage.prototype.getTileCanvas=function(x,y){var a=this.internalCanvas.getContext('2d');var b=document.createElement('canvas');b.width=this.width;b.height=this.height;b.getContext('2d').putImageData(a.getImageData(x*this.width,y*this.height,this.width,this.height),0,0);return b};var EditableImage=function(a,b){var c=this,cc2d;c.internalCanvas=document.createElement('canvas');c.width=undefined;c.height=undefined;if(typeof a==='number'){c.internalCanvas.width=c.width=a;c.internalCanvas.height=c.height=b;cc2d=c.internalCanvas.getContext('2d');c.imageData=cc2d.getImageData(0,0,c.width,c.height);return}if(typeof a==='string'){var d=new Image();d.src=a;c.src=a;d.onload=function(){c.internalCanvas.width=d.width;c.internalCanvas.height=d.height;cc2d=c.internalCanvas.getContext('2d');cc2d.clearRect(0,0,d.width,d.height);cc2d.drawImage(d,0,0);c.imageData=cc2d.getImageData(0,0,d.width,d.height);c.width=d.width;c.height=d.height;if(typeof c.onload==='function'){c.onload()}};d.onerror=function(){if(typeof c.onerror==='function'){c.onerror()}}}};EditableImage.prototype.getPixel=function(x,y){if(this.imageData!==undefined){return{R:this.imageData.data[(this.imageData.width*y+x)*4],G:this.imageData.data[(this.imageData.width*y+x)*4+1],B:this.imageData.data[(this.imageData.width*y+x)*4+2],A:this.imageData.data[(this.imageData.width*y+x)*4+3]}}};EditableImage.prototype.setPixel=function(x,y,a){if(this.imageData!==undefined){this.imageData.data[(this.imageData.width*y+x)*4]=a.R;this.imageData.data[(this.imageData.width*y+x)*4+1]=a.G;this.imageData.data[(this.imageData.width*y+x)*4+2]=a.B;this.imageData.data[(this.imageData.width*y+x)*4+3]=a.A}};EditableImage.prototype.forPixels=function(a){var x,y;for(y=0;y<this.height;y++){for(x=0;x<this.width;x++){a(x,y)}}};EditableImage.prototype.putToCanvas=function(a,x,y){a.getContext('2d').putImageData(this.imageData,x,y)};EditableImage.prototype.blendToCanvas=function(a,x,y,w,h){var b=this.internalCanvas.getContext('2d');b.clearRect(0,0,this.width,this.height);b.putImageData(this.imageData,0,0);a.getContext('2d').drawImage(this.internalCanvas,x,y,w,h)};EditableImage.prototype.toImage=function(){var a=document.createElement("img");a.src=this.toDataURL();return a};EditableImage.prototype.toDataURL=function(){var a=this.internalCanvas.getContext('2d');a.clearRect(0,0,this.width,this.height);a.putImageData(this.imageData,0,0);return this.internalCanvas.toDataURL()};var PaintType={MATTE:0,GLOSS:1,METAL:2,PEARL:3,FLIP:4};var Paint=function(b,c,d){var e=this;var f=function(a){if(a.match(/^#[0-9A-Fa-f]+$/)){if(a.length===4){return{r:parseInt(a.charAt(1)+a.charAt(1),16)/255,g:parseInt(a.charAt(2)+a.charAt(2),16)/255,b:parseInt(a.charAt(3)+a.charAt(3),16)/255}}if(a.length===7){return{r:parseInt(a.substr(1,2),16)/255,g:parseInt(a.substr(3,2),16)/255,b:parseInt(a.substr(5,2),16)/255}}}throw new Error("Invalid colour "+a);};if(typeof d==='string'){switch(d.toUpperCase()){case'MATTE':d=PaintType.MATTE;break;case'GLOSS':d=PaintType.GLOSS;break;case'METALLIC':d=PaintType.METAL;break;case'PEARLESCENT':d=PaintType.PEARL;break;case'FLIP':d=PaintType.FLIP;break}}if(typeof d!=='number'||d<0||d>PaintType.FLIP){throw new TypeError("Invalid paint type: "+d);}e.c1=f(b);e.c2=f(c);e.type=d};var MultiLoader=function(a){var b=this,target=0,i=0;var c=function(){if(--target===0){a()}};var d=function(x){throw new Error("A resource "+x.src+" could not be loaded.");};b.Load=function(){for(i=0;i<arguments.length;i++){target++;arguments[i].onload=c;arguments[i].onerror=(function(x){return function(){d(x)}}(arguments[i]))}}};var LiveryMapper=function(D,E,F,G,H){var I=this;var J=0.15;var K=0.5;var L=1.0;var M=0.8/255;var N=1.0/255;var O=100;var P=new EditableImage(F);var Q=new UVDataLoadable(E+"uv.js");var R=new TiledImage(E+"diffuse.jpg",1,3);var S=new TiledImage(E+"specular.jpg",1,3);var T=new TiledImage(E+"other.jpg",1,2);var U=new Image();U.src=E+"alpha.png";var V,height,result;var W=document.createElement('canvas');var X=D.getContext('2d');X.globalCompositeOperation='copy';var Y=false;var Z=new MultiLoader(function(){var a=new Date().getTime();V=T.width;height=T.height;result=new EditableImage(V,height);var b=T.getTileCanvas(0,0);W.width=b.width;W.height=b.height;var c=W.getContext('2d');c.drawImage(U,0,0);c.globalCompositeOperation='source-atop';c.drawImage(b,0,0);if(window.console){console.log("Post-load: "+(new Date().getTime()-a)+"ms")}I.DoMapping()});Z.Load(U,S,R,T,Q,P);I.SetLivery=function(a){P=new EditableImage(a);Z.Load(P)};I.Paints=[new Paint("#FFFF00","#000000",PaintType.MATTE),new Paint("#00FF00","#000000",PaintType.MATTE),new Paint("#0000FF","#000000",PaintType.MATTE),new Paint("#00FFFF","#000000",PaintType.MATTE)];I.DoMapping=function(){if(Y){return}Y=true;var c=I.Paints[0].c1.r,c00g=I.Paints[0].c1.g,c00b=I.Paints[0].c1.b,c10r=I.Paints[1].c1.r,c10g=I.Paints[1].c1.g,c10b=I.Paints[1].c1.b,c20r=I.Paints[2].c1.r,c20g=I.Paints[2].c1.g,c20b=I.Paints[2].c1.b,c30r=I.Paints[3].c1.r,c30g=I.Paints[3].c1.g,c30b=I.Paints[3].c1.b;var d=I.Paints[0].c2.r,c01g=I.Paints[0].c2.g,c01b=I.Paints[0].c2.b,c11r=I.Paints[1].c2.r,c11g=I.Paints[1].c2.g,c11b=I.Paints[1].c2.b,c21r=I.Paints[2].c2.r,c21g=I.Paints[2].c2.g,c21b=I.Paints[2].c2.b,c31r=I.Paints[3].c2.r,c31g=I.Paints[3].c2.g,c31b=I.Paints[3].c2.b;var e=0,l1=0,l2=0,lb=0,lidx0=0,cr=0,cg=0,cb=0;var f=I.Paints[0].type,c1type=I.Paints[1].type,c2type=I.Paints[2].type,c3type=I.Paints[3].type;var g=result.imageData.data;var h=R.getTileData(0,0).data;var j=R.getTileData(0,1).data;var k=R.getTileData(0,2).data;var l=S.getTileData(0,0).data;var m=S.getTileData(0,1).data;var n=S.getTileData(0,2).data;var o=T.getTileData(0,1).data;var p=P.imageData.data;var q=P.width;var r=P.height;var s=Q.data;var t=2*J*J;var v=q/65536;var w=r/65536;var u=0;var i=0;var a=0;var x=0;var y=0,ig=0,ib=0,ia=0;var z=s.length;var A=0;var B=0;var C=function(){var b=new Date().getTime();while(u<z){if(i===A){i+=(s[u]+s[u+1]*256)*4;B=(s[u+2]+s[u+3]*256);A=i+B*4;u+=4}while(i<A){y=i;ig=i+1;ib=i+2;ia=i+3;lidx0=(~~((s[u]+s[u+B*2]*256)*v)+(q*~~((s[u+B]+s[u+(B*3)]*256)*w)))*4;u+=1;e=p[lidx0]/255;l1=p[lidx0+1]/255;l2=p[lidx0+2]/255;lb=1.0-(e+l1+l2);cr=cg=cb=0;if(lb!==0){switch(f){case 0:cr+=(c*j[y]*N+m[y]*M)*lb;cg+=(c00g*j[ig]*N+m[ig]*M)*lb;cb+=(c00b*j[ib]*N+m[ib]*M)*lb;break;case 1:cr+=(c*h[y]*N+l[y]*M)*lb;cg+=(c00g*h[ig]*N+l[ig]*M)*lb;cb+=(c00b*h[ib]*N+l[ib]*M)*lb;break;case 2:cr+=(c*k[y]*N+n[y]*M)*lb;cg+=(c00g*k[ig]*N+n[ig]*M)*lb;cb+=(c00b*k[ib]*N+n[ib]*M)*lb;break;case 3:x=(o[y]/255)-K;a=1.0-L*Math.exp(-(x*x)/t);cr+=(Math.min(d*(1.0-a)+c,1)*k[y]*N+n[y]*M)*lb;cg+=(Math.min(c01g*(1.0-a)+c00g,1)*k[ig]*N+n[ig]*M)*lb;cb+=(Math.min(c01b*(1.0-a)+c00b,1)*k[ib]*N+n[ib]*M)*lb;break;case 4:a=o[y]/255;cr+=(Math.min(d*(1.0-a)+c*a,1)*k[y]*N+n[y]*M)*lb;cg+=(Math.min(c01g*(1.0-a)+c00g*a,1)*k[ig]*N+n[ig]*M)*lb;cb+=(Math.min(c01b*(1.0-a)+c00b*a,1)*k[ib]*N+n[ib]*M)*lb;break}}if(e!==0){switch(c1type){case 0:cr+=(c10r*j[y]*N+m[y]*M)*e;cg+=(c10g*j[ig]*N+m[ig]*M)*e;cb+=(c10b*j[ib]*N+m[ib]*M)*e;break;case 1:cr+=(c10r*h[y]*N+l[y]*M)*e;cg+=(c10g*h[ig]*N+l[ig]*M)*e;cb+=(c10b*h[ib]*N+l[ib]*M)*e;break;case 2:cr+=(c10r*k[y]*N+n[y]*M)*e;cg+=(c10g*k[ig]*N+n[ig]*M)*e;cb+=(c10b*k[ib]*N+n[ib]*M)*e;break;case 3:x=(o[y]/255)-K;a=1.0-L*Math.exp(-(x*x)/t);cr+=(Math.min(c11r*(1.0-a)+c10r,1)*k[y]*N+n[y]*M)*e;cg+=(Math.min(c11g*(1.0-a)+c10g,1)*k[ig]*N+n[ig]*M)*e;cb+=(Math.min(c11b*(1.0-a)+c10b,1)*k[ib]*N+n[ib]*M)*e;break;case 4:a=o[y]/255;cr+=(Math.min(c11r*(1.0-a)+c10r*a,1)*k[y]*N+n[y]*M)*e;cg+=(Math.min(c11g*(1.0-a)+c10g*a,1)*k[ig]*N+n[ig]*M)*e;cb+=(Math.min(c11b*(1.0-a)+c10b*a,1)*k[ib]*N+n[ib]*M)*e;break}}if(l1!==0){switch(c2type){case 0:cr+=(c20r*j[y]*N+m[y]*M)*l1;cg+=(c20g*j[ig]*N+m[ig]*M)*l1;cb+=(c20b*j[ib]*N+m[ib]*M)*l1;break;case 1:cr+=(c20r*h[y]*N+l[y]*M)*l1;cg+=(c20g*h[ig]*N+l[ig]*M)*l1;cb+=(c20b*h[ib]*N+l[ib]*M)*l1;break;case 2:cr+=(c20r*k[y]*N+n[y]*M)*l1;cg+=(c20g*k[ig]*N+n[ig]*M)*l1;cb+=(c20b*k[ib]*N+n[ib]*M)*l1;break;case 3:x=(o[y]/255)-K;a=1.0-L*Math.exp(-(x*x)/t);cr+=(Math.min(c21r*(1.0-a)+c20r,1)*k[y]*N+n[y]*M)*l1;cg+=(Math.min(c21g*(1.0-a)+c20g,1)*k[ig]*N+n[ig]*M)*l1;cb+=(Math.min(c21b*(1.0-a)+c20b,1)*k[ib]*N+n[ib]*M)*l1;break;case 4:a=o[y]/255;cr+=(Math.min(c21r*(1.0-a)+c20r*a,1)*k[y]*N+n[y]*M)*l1;cg+=(Math.min(c21g*(1.0-a)+c20g*a,1)*k[ig]*N+n[ig]*M)*l1;cb+=(Math.min(c21b*(1.0-a)+c20b*a,1)*k[ib]*N+n[ib]*M)*l1;break}}if(l2!==0){switch(c3type){case 0:cr+=(c30r*j[y]*N+m[y]*M)*l2;cg+=(c30g*j[ig]*N+m[ig]*M)*l2;cb+=(c30b*j[ib]*N+m[ib]*M)*l2;break;case 1:cr+=(c30r*h[y]*N+l[y]*M)*l2;cg+=(c30g*h[ig]*N+l[ig]*M)*l2;cb+=(c30b*h[ib]*N+l[ib]*M)*l2;break;case 2:cr+=(c30r*k[y]*N+n[y]*M)*l2;cg+=(c30g*k[ig]*N+n[ig]*M)*l2;cb+=(c30b*k[ib]*N+n[ib]*M)*l2;break;case 3:x=(o[y]/255)-K;a=1.0-L*Math.exp(-(x*x)/t);cr+=(Math.min(c31r*(1.0-a)+c30r,1)*k[y]*N+n[y]*M)*l2;cg+=(Math.min(c31g*(1.0-a)+c30g,1)*k[ig]*N+n[ig]*M)*l2;cb+=(Math.min(c31b*(1.0-a)+c30b,1)*k[ib]*N+n[ib]*M)*l2;break;case 4:a=o[y]/255;cr+=(Math.min(c31r*(1.0-a)+c30r*a,1)*k[y]*N+n[y]*M)*l2;cg+=(Math.min(c31g*(1.0-a)+c30g*a,1)*k[ig]*N+n[ig]*M)*l2;cb+=(Math.min(c31b*(1.0-a)+c30b*a,1)*k[ib]*N+n[ib]*M)*l2;break}}g[y]=cr*255;g[ig]=cg*255;g[ib]=cb*255;g[ia]=255;i+=4}u+=B*3;if(b<new Date().getTime()-O){if(H){D.progress=(1/z)*u;H.apply(D)}setTimeout(C,1);return}}Y=false;if(window.console){console.log("Mapped ("+(new Date().getTime()-b)+"ms)")}result.blendToCanvas(W,0,0,W.width,W.height);X.drawImage(W,0,0,D.width,D.height);g=h=j=k=l=m=n=o=p=s=undefined;if(H){D.progress=1;H.apply(D)}if(G){G.apply(D)}};if(H){D.progress=0;H.apply(D)}C()}};window.addEventListener('load',function(){[].forEach.call(document.querySelectorAll('.livery'),function(a){var b=[],i,paint,livery,baseUri,progressEvent,loadEvent,mapper;for(i=0;i<4;i++){paint=a.getAttribute('data-paint'+i).split(/\s+/);b.push(new Paint(paint[0],paint[1],paint[2]))}livery=a.getAttribute('data-livery');baseUri=a.getAttribute('data-baseuri');progressEvent=a.getAttribute('data-onprogress');loadEvent=a.getAttribute('data-onload');if(!loadEvent){loadEvent=a.getAttribute('onload')}mapper=new LiveryMapper(a,baseUri,livery,loadEvent?new Function(loadEvent):null,progressEvent?new Function(progressEvent):null);mapper.Paints=b})},false);